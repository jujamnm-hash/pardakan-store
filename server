# =========================================
# Imports
# =========================================
from flask import Flask, jsonify, request
from flask_cors import CORS
import sqlite3
from datetime import datetime, timedelta
import json
import os

# =========================================
# Flask App Setup
# =========================================
app = Flask(__name__)
CORS(app)

DATABASE = 'store.db'

# =========================================
# Database Helper Functions
# =========================================
def get_db_connection():
    """Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• Ø¯Ø§ØªØ§Ø¨Û•ÛŒØ³"""
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¬Ø¯ÙˆÙ„Û•Ú©Ø§Ù† Ùˆ Ø¯Ø§ØªØ§ÛŒ Ù†Ù…ÙˆÙˆÙ†Û•ÛŒ"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # Create products table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            description TEXT,
            price REAL NOT NULL,
            stock_quantity INTEGER NOT NULL DEFAULT 0,
            category TEXT,
            image_url TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Create orders table
    cursor. execute('''
        CREATE TABLE IF NOT EXISTS orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            customer_name TEXT NOT NULL,
            customer_phone TEXT NOT NULL,
            customer_address TEXT,
            total_amount REAL NOT NULL,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Create order_items table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS order_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            order_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            product_name TEXT NOT NULL,
            quantity INTEGER NOT NULL,
            price REAL NOT NULL,
            subtotal REAL NOT NULL,
            FOREIGN KEY (order_id) REFERENCES orders(id),
            FOREIGN KEY (product_id) REFERENCES products(id)
        )
    ''')
    
    # Create inventory_log table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS inventory_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_id INTEGER NOT NULL,
            change_type TEXT NOT NULL,
            quantity_change INTEGER NOT NULL,
            previous_quantity INTEGER NOT NULL,
            new_quantity INTEGER NOT NULL,
            note TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (product_id) REFERENCES products(id)
        )
    ''')
    
    # Check if we need to add sample data
    cursor.execute('SELECT COUNT(*) as count FROM products')
    count = cursor.fetchone()['count']
    
    if count == 0:
        print('Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§ÛŒ Ù†Ù…ÙˆÙˆÙ†Û•ÛŒ.. .')
        sample_products = [
            {
                'name': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Blackout - Ú•Û•Ø´',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒÛ•Ú©ÛŒ Ø¨Û•Ú©ÙˆØ§ÚµÛØªÛŒ Ø¨Û•Ø±Ø²ØŒ Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ø¨Û• ØªÛ•ÙˆØ§ÙˆÛŒ Ø¯Û•Ú¯Ø±ÛØªØŒ Ú¯ÙˆÙ†Ø¬Ø§ÙˆÛ• Ø¨Û† Ú˜ÙˆÙˆØ±ÛŒ Ù†ÙˆØ³ØªÙ†',
                'price': 45000,
                'stock_quantity':  50,
                'category': 'Blackout',
                'image_url': 'https://images.unsplash.com/photo-1616486029423-aaa4789e8c9a?w=500'
            },
            {
                'name': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Blackout - Ø³Ù¾ÛŒ',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ø³Ù¾ÛŒ Ø¨Û† Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ú¯Ø±ØªÙ†ØŒ Ø¯ÛŒØ²Ø§ÛŒÙ†ÛŒ Ù…Û†Ø¯ÛØ±Ù†',
                'price': 42000,
                'stock_quantity': 45,
                'category': 'Blackout',
                'image_url': 'https://images.unsplash.com/photo-1591088398332-8a7791972843?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Sheer - Ú©Ø±ÛÙ…ÛŒ',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒÛ•Ú©ÛŒ Ø³ÙˆÙˆÚ© Ùˆ Ø´Û•ÙØ§ÙØŒ Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ù†Û•Ø±Ù… Ø¯Û•Ø¨Û•Ø®Ø´ÛØª',
                'price': 35000,
                'stock_quantity': 60,
                'category': 'Sheer',
                'image_url': 'https://images.unsplash.com/photo-1604709095912-ad5f1b729f9d?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Sheer - Ø³ÙˆÙˆØ±',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ø´Û•ÙØ§ÙÛŒ Ø³ÙˆÙˆØ±ØŒ Ø¯Ø±ÙˆØ³ØªÚ©Û•Ø±ÛŒ Ú©Û•Ø´ÛÚ©ÛŒ Ú¯Û•Ø±Ù…',
                'price': 38000,
                'stock_quantity': 35,
                'category': 'Sheer',
                'image_url': 'https://images.unsplash.com/photo-1602941525421-8f8b81d3edbb?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Thermal - Ù‚Ø§ÙˆÛ•ÛŒÛŒ',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ú¯Û•Ø±Ù…ÛŒØŒ Ù¾Ø§Ø±Ø§Ø³ØªÙ† Ù„Û• Ø³Û•Ø±Ù…Ø§ Ùˆ Ú¯Û•Ø±Ù…Ø§',
                'price': 55000,
                'stock_quantity': 30,
                'category': 'Thermal',
                'image_url': 'https://images.unsplash.com/photo-1616594266467-81e92a99f2e9?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Decorative - Ø²ÛÚ•ÛŒÙ†',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ú•Ø§Ø²Ø§ÙˆÛ• Ø¨Û• Ù†Û•Ø®Ø´ÛŒ Ø¬ÙˆØ§Ù†ØŒ Ø²ÛÚ•ÛŒÙ†ÛŒ Ú•Û•Ù†Ú¯',
                'price':  65000,
                'stock_quantity': 25,
                'category': 'Decorative',
                'image_url': 'https://images.unsplash.com/photo-1600210491892-03d54c0aaf87?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Decorative - Ø´ÛŒÙ†',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ø´ÛŒÙ†ÛŒ Ú•Û†ÛŒØ§Ù„ØŒ Ù†Û•Ø®Ø´ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©',
                'price': 58000,
                'stock_quantity': 28,
                'category': 'Decorative',
                'image_url': 'https://images.unsplash.com/photo-1593115057116-e1bb2f9eb7ff?w=500'
            },
            {
                'name':  'Roller Blind - Ø³Ù¾ÛŒ',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ú•Û†Ù„Û•Ø± Ù…Û†Ø¯ÛØ±Ù†ØŒ Ø¦Ø§Ø³Ø§Ù†Û• Ø¨Û† Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Ø§Ù†',
                'price': 40000,
                'stock_quantity': 40,
                'category': 'Roller',
                'image_url': 'https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?w=500'
            },
            {
                'name':  'Roller Blind - Ú•Û•Ø³Ø§Ø³ÛŒ',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ú•Û†Ù„Û•Ø±ØŒ Ú•Û•Ù†Ú¯ÛŒ Ú•Û•Ø³Ø§Ø³ÛŒØŒ Ø¯ÛŒØ²Ø§ÛŒÙ†ÛŒ Ø³Ø§Ú©Ø§Ø±',
                'price': 42000,
                'stock_quantity': 35,
                'category': 'Roller',
                'image_url': 'https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?w=500'
            },
            {
                'name':  'Vertical Blind - Ø³Ù¾ÛŒ',
                'description':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Ø³ØªÙˆÙˆÙ†ÛŒØŒ Ú¯ÙˆÙ†Ø¬Ø§Ùˆ Ø¨Û† Ù¾Û•Ù†Ø¬Û•Ø±Û•ÛŒ Ú¯Û•ÙˆØ±Û•',
                'price': 50000,
                'stock_quantity': 20,
                'category': 'Vertical',
                'image_url': 'https://images.unsplash.com/photo-1616594266467-81e92a99f2e9?w=500'
            },
            {
                'name': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Blackout - Ø³ÙˆÙˆØ± ØªØ§Ø±ÛŒÚ©',
                'description': 'Ù¾Û•Ø±Ø¯Û•ÛŒ Ø³ÙˆÙˆØ±ÛŒ Ø¦Û•ÚµÛ•Ú¯Ø§Ù†ØªØŒ Ø¯Ú˜ÛŒ Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ',
                'price': 48000,
                'stock_quantity': 8,
                'category': 'Blackout',
                'image_url': 'https://images.unsplash.com/photo-1616594039964-ae9021a400a0?w=500'
            },
            {
                'name':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Thermal - Ú•Û•Ø³Ø§Ø³ÛŒ',
                'description':  'Ù¾Û•Ø±Ø¯Û•ÛŒ Ú¯Û•Ø±Ù…ÛŒ Ú•Û•Ø³Ø§Ø³ÛŒØŒ Ú©ÙˆØ§ÚµÛØªÛŒ Ø¨Û•Ø±Ø²',
                'price': 52000,
                'stock_quantity': 5,
                'category': 'Thermal',
                'image_url': 'https://images.unsplash.com/photo-1600210492493-0946911123ea?w=500'
            }
        ]
        
        for product in sample_products:
            cursor.execute('''
                INSERT INTO products (name, description, price, stock_quantity, category, image_url)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (
                product['name'],
                product['description'],
                product['price'],
                product['stock_quantity'],
                product['category'],
                product['image_url']
            ))
        
        print(f'{len(sample_products)} Ø¨Û•Ø±Ù‡Û•Ù… Ø²ÛŒØ§Ø¯Ú©Ø±Ø§Ù†!')
    
    conn.commit()
    conn.close()
    print('Ø¯Ø§ØªØ§Ø¨Û•ÛŒØ³ Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•!')

# =========================================
# API Routes - Products
# =========================================
@app.route('/api/products', methods=['GET'])
def get_products():
    """ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†"""
    try:
        conn = get_db_connection()
        products = conn.execute('SELECT * FROM products ORDER BY id DESC').fetchall()
        conn.close()
        
        return jsonify([dict(product) for product in products])
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/products/<int: product_id>', methods=['GET'])
def get_product(product_id):
    """ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…ÛÚ©ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ"""
    try:
        conn = get_db_connection()
        product = conn.execute('SELECT * FROM products WHERE id = ?', (product_id,)).fetchone()
        conn.close()
        
        if product is None:
            return jsonify({'error': 'Ø¨Û•Ø±Ù‡Û•Ù… Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•'}), 404
        
        return jsonify(dict(product))
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/products', methods=['POST'])
def create_product():
    """Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…ÛŒ Ù†ÙˆÛ"""
    try: 
        data = request.get_json()
        
        required_fields = ['name', 'price', 'stock_quantity', 'category']
        for field in required_fields:
            if field not in data:
                return jsonify({'error': f'Ø®Ø§Ù†Û•ÛŒ {field} Ù¾ÛÙˆÛŒØ³ØªÛ•'}), 400
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO products (name, description, price, stock_quantity, category, image_url)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            data['name'],
            data. get('description', ''),
            data['price'],
            data['stock_quantity'],
            data['category'],
            data.get('image_url', None)
        ))
        
        product_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        return jsonify({'message': 'Ø¨Û•Ø±Ù‡Û•Ù… Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø§', 'id': product_id}), 201
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/orders', methods=['POST'])
def create_order():
    """Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ ÙˆÛ•Ø³ÚµÛŒ Ù†ÙˆÛ"""
    try: 
        data = request.get_json()
        
        required_fields = ['customer_name', 'customer_phone', 'total_amount', 'items']
        for field in required_fields:
            if field not in data:
                return jsonify({'error': f'Ø®Ø§Ù†Û•ÛŒ {field} Ù¾ÛÙˆÛŒØ³ØªÛ•'}), 400
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO orders (customer_name, customer_phone, customer_address, total_amount, status)
            VALUES (?, ?, ?, ?, 'pending')
        ''', (
            data['customer_name'],
            data['customer_phone'],
            data.get('customer_address', ''),
            data['total_amount']
        ))
        
        order_id = cursor.lastrowid
        
        for item in data['items']:
            subtotal = item['price'] * item['quantity']
            
            cursor.execute('''
                INSERT INTO order_items (order_id, product_id, product_name, quantity, price, subtotal)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (
                order_id,
                item['product_id'],
                item['product_name'],
                item['quantity'],
                item['price'],
                subtotal
            ))
            
            cursor.execute('''
                UPDATE products 
                SET stock_quantity = stock_quantity - ?  
                WHERE id = ? 
            ''', (item['quantity'], item['product_id']))
        
        conn.commit()
        conn.close()
        
        return jsonify({'message': 'ÙˆÛ•Ø³Úµ Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø§', 'order_id': order_id}), 201
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# =========================================
# Root Route
# =========================================
@app. route('/')
def index():
    """Ù¾Û•Ú•Û•ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ"""
    return '''
    <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>API Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¯ÙˆÚ©Ø§Ù†ÛŒ Ù¾Û•Ø±Ø¯Û•</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 50px auto;
                    padding:  20px;
                    background:  #f5f5f5;
                }
                .container {
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                h1 {
                    color: #2c3e50;
                    text-align: center;
                }
                .status {
                    background: #27ae60;
                    color:  white;
                    padding: 10px;
                    border-radius: 5px;
                    text-align: center;
                    margin: 20px 0;
                }
                .endpoints {
                    background: #ecf0f1;
                    padding: 20px;
                    border-radius: 5px;
                    margin-top: 20px;
                }
                .endpoint {
                    margin: 10px 0;
                    padding: 10px;
                    background: white;
                    border-radius:  3px;
                }
                . method {
                    display: inline-block;
                    padding: 3px 8px;
                    border-radius: 3px;
                    font-weight: bold;
                    margin-left: 10px;
                }
                .get { background: #3498db; color: white; }
                .post { background: #27ae60; color: white; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸª API Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¯ÙˆÚ©Ø§Ù†ÛŒ Ù¾Û•Ø±Ø¯Û•</h1>
                <div class="status">
                    âœ“ Ø³ÛØ±Ú¤Û•Ø± Ú©Ø§Ø±Ø¯Û•Ú©Ø§Øª Ùˆ Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•
                </div>
                
                <h2>API Endpoints: </h2>
                <div class="endpoints">
                    <h3>Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†: </h3>
                    <div class="endpoint">
                        <span class="method get">GET</span>
                        <code>/api/products</code> - Ù‡Û•Ù…ÙˆÙˆ Ø¨Û•Ø±Ù‡Û•Ù…Û•Ú©Ø§Ù†
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span>
                        <code>/api/products/: id</code> - Ø¨Û•Ø±Ù‡Û•Ù…ÛÚ©ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span>
                        <code>/api/products</code> - Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ù‡Û•Ù…
                    </div>
                    
                    <h3>ÙˆÛ•Ø³ÚµÛ•Ú©Ø§Ù†:</h3>
                    <div class="endpoint">
                        <span class="method post">POST</span>
                        <code>/api/orders</code> - Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ ÙˆÛ•Ø³Úµ
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 30px; color: #7f8c8d;">
                    Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø§ÙˆÛ• Ø¨Û• â¤ï¸ Ø¨Û† Ú©Û†Ù…Û•ÚµÚ¯Û•ÛŒ Ú©ÙˆØ±Ø¯ÛŒ
                </p>
            </div>
        </body>
    </html>
    '''

# =========================================
# Main
# =========================================
if __name__ == '__main__':
    print('='*50)
    print('ğŸš€ Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ø³ÛØ±Ú¤Û•Ø±ÛŒ Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¯ÙˆÚ©Ø§Ù†ÛŒ Ù¾Û•Ø±Ø¯Û•')
    print('='*50)
    
    init_db()
    
    print('\nâœ“ Ø³ÛØ±Ú¤Û•Ø± Ú©Ø§Ø±Ø¯Û•Ú©Ø§Øª Ù„Û•Ø³Û•Ø±:  http://localhost:5000')
    print('âœ“ ÙØ§ÛŒÙ„ÛŒ index.html Ø¨Ú©Û•Ø±Û•ÙˆÛ• Ù„Û• ÙˆÛØ¨Ú¯Û•Ú•Û•Ú©Û•Øª\n')
    print('Ø¨Û† ÙˆÛ•Ø³ØªØ§Ù†Ø¯Ù†:  Ctrl+C Ø¨Ú©Û•\n')
    
    app.run(debug=True, host='0.0.0.0', port=5000)